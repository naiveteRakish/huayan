/**  
 *dao调用类
 * @Title: SqlFunctionDao.java
 * @Package com.whayer.cloud.storage.component.foundation.res.dao
 * @author Administrator
 * @date 2017年8月21日 下午6:34:33
 * @version v1.0.0
 */
package com.whayer.cloud.storage.component.foundation.res.dao;

import org.hibernate.Query;
import org.hibernate.SQLQuery;
import org.hibernate.Session;

import whayer.cloud.framework.data.db.dao.datasource.HibernateDbSession;

import com.whayer.cloud.storage.component.foundation.access.beans.TableRowPojo;

/**
 * 执行函数
 * @ClassName: SqlFunctionDao
 * @author Administrator
 * @date 2017年8月21日 下午6:34:33
 * @version v1.0.0
 * 
 */
public class SqlFunctionDaoImpl implements ISqlFunctionDao {

	private HibernateDbSession hibernateDbSession;

	/**
	 * @param hibernateDbSession the hibernateDbSession to set
	 */
	public void setHibernateDbSession(HibernateDbSession hibernateDbSession) {
		this.hibernateDbSession = hibernateDbSession;
	}

	public TableRowPojo getRowByCode(String code) {
		Session session = hibernateDbSession.getSession();
		SQLQuery sqlQuery = session.createSQLQuery("select getParentByCode(?)");
		sqlQuery.setParameter(0, code);
		String id = (String) sqlQuery.uniqueResult();
		TableRowPojo tableRowPojo = null;
		// 这里正在优化函数 到时候就可以减少一次访问数据库
		if (id == null || "".equals(id)) {
			sqlQuery = session.createSQLQuery("select id from BaseDeviceInfo where `code` = ?");
			sqlQuery.setParameter(0, code);
			id = (String) sqlQuery.uniqueResult();
		}
		if (id != null && !"".equals(id)) {
			Query query = session.createQuery("from  TableRowPojo  where id =:paramId");
			query.setParameter("paramId", id);
			tableRowPojo = (TableRowPojo) query.uniqueResult();
		}
		return tableRowPojo;

	}

	public TableRowPojo getRowById(String id) {
		Session session = hibernateDbSession.getSession();
		SQLQuery sqlQuery = session.createSQLQuery("select getParentById(?)");
		sqlQuery.setParameter(0, id);
		String dbId = (String) sqlQuery.uniqueResult();
		TableRowPojo tableRowPojo = null;
		if (dbId == null || "".equals(dbId)) {
			dbId = id;
		}
		Query query = session.createQuery("from  TableRowPojo  where id = :id");
		query.setParameter("id", dbId);
		tableRowPojo = (TableRowPojo) query.uniqueResult();

		return tableRowPojo;
	}
}
